Deploiment practice:
https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/
https

per il funzionamento di WeasyPrint serve il pacchetto di sistema:
apt install libpangocairo-1.0-0



Comandi utili

Impostazioni nginx e gunicorn:
    sudo nano /etc/nginx/sites-available/documanager
    Su aws linux:
    (sudo nano /etc/nginx/conf.d/documanager.conf)
    sudo nano /etc/systemd/system/gunicorn.service

Riavviare i servizi
    sudo systemctl daemon-reload
    sudo systemctl restart gunicorn
    sudo systemctl restart nginx

File di log di Nginx e Gunicorn
    sudo tail -f /var/log/nginx/error.log
    sudo journalctl -u gunicorn --since "5 minutes ago"
    sudo systemctl status gunicorn

Scopri se gunicorn legge l'environment:
    sudo systemctl show-environment | grep DEBUG
Avvia Gunicorn manualmente sulla porta 8000 (la porta deve essere sbloccata nei gruppi di permessi)
    gunicorn --bind 0.0.0.0:8000 documanager.wsgi:application --reload
Avvia Gunicorn manualmente con le stesse impostazioni (potenzialmente) di systemd
    /var/www/documanager/venv/bin/gunicorn \
    --bind unix:/var/www/documanager/run/gunicorn.sock \
    --chdir /var/www/documanager \
    core.wsgi:application --reload --log-level debug
Triggera manualmente il file socket (dovresti ottenere la risposta in html)
    curl -L --unix-socket /var/www/documanager/run/gunicorn.sock http://localhost/defunti



sudo mkdir -p /run/gunicorn
sudo chown ubuntu:www-data /run/gunicorn

Indirizzi dns per connettersi con ssh:
ssh -i "/home/cristian/.ssh/ArchettiEC2@LenovoG500.pem" ubuntu@ec2-16-171-113-111.eu-north-1.compute.amazonaws.com
ssh -i "/home/riso/.ssh/ArchettiEC2.pem" ubuntu@ec2-13-51-193-252.eu-north-1.compute.amazonaws.com
ssh -i "/home/riso/.ssh/ArchettiEC2.pem" ec2-user@ec2-13-60-228-41.eu-north-1.compute.amazonaws.com



cd /media/riso/
sudo mkdir TOSHIBA\ EXT
ls
sudo mount -t ntfs-3g /dev/sda1 /media/riso/TOSHIBA\ EXT


--------------------------------------------------

Processo setup nuovo server:

scambio le chiavi di sicurezza con il provider
scopro il nome utente (ec2-user o ubuntu o altri)
scopro l'indirizzo pubblico DNS del server (ec2-13-53-205-189.eu-north-1.compute.amazonaws.com in questo caso)
entro nel server
    ssh -i "/home/riso/.ssh/ArchettiEC2.pem" ec2-user@ec2-13-53-205-189.eu-north-1.compute.amazonaws.com
aggiorno i pacchetti alle versioni di sviluppo
    sudo yum update
    sudo yum upgrade
(ad esempio qui aggiorno varie cose. credits https://tecadmin.net/how-to-install-python-3-12-on-amazon-linux/ 
e https://stackoverflow.com/questions/1210664/no-module-named-sqlite3 e 
https://www.giannifavilli.it/blog/python-django-su-webserver-nginx-e-gunicorn/ 
        Utilizzare privilegi di root o sudo.

        apt install python3 python3-pip python3-venv python3-dev
        apt install nginx supervisor
        apt install sqlite3
        Opzionali

        apt install curl git nano build-essential ‚Äì Tool Sviluppo
        apt install python3-certbot-nginx ‚Äì Certbot
        apt install libpq-dev postgresql postgresql-contrib ‚Äì PostgreSQL)
Qui installo python
    sudo yum groupinstall "Development Tools" -y
    sudo yum install gcc openssl-devel bzip2-devel libffi-devel -y
    sudo yum install sqlite-devel -y
    cd /usr/src
    sudo wget https://www.python.org/ftp/python/3.12.2/Python-3.12.2.tgz
    sudo tar xzf Python-3.12.2.tgz
    cd Python-3.12.2
    sudo ./configure --enable-optimizations --enable-loadable-sqlite-extensions
    sudo make
    sudo make altinstall
    python3.12 --version
(qui installo pip)
    sudo curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    sudo python3.12 get-pip.py
    pip3.12 --version
(qui installo virtualenv)
    pip install virtualenv
(qui installo nginx e supervisor)
    sudo yum install nginx
(qui installo git)
    sudo yum install git
Creo la cartella del progetto
    sudo mkdir -p /var/www/documanager
Setto la propriet√† in modo che sia accessibile da gunicorn e nginx, ma prima controllo qual √® il gruppo di
nginx osservando quali di questi due comandi ha un output:
    getent group nginx
    getent group www-data
Procedo con modificare la propriet√† e i diritti (vedi https://www.giannifavilli.it/blog/python-django-su-webserver-nginx-e-gunicorn/):
    # chown www-data:users /var/www/django-webapp
    # chmod g+w /var/www/django-webapp
    sudo chown -R ec2-user:nginx /var/www/documanager
    sudo chmod 2775 /var/www/documanager
Aggiungi il tuo utente al gruppo nginx
    sudo usermod -a -G nginx ec2-user
creo una nuova coppia di chiavi e scambio la chiave pubblica con github
    cd ~/.ssh/
    ssh-keygen -t ed25519 -C "eraclesax@github.com"
Adding your SSH key to the ssh-agent
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519
(se serve cambio i permessi di accesso e apertura della chiave e della cartella ssh)
    chmod ...
copio la chiave pubblica in github
    nano ~/.ssh/id_ed25519.pub
    -> copio la chiave in github
clono la repository
    cd ~/
    git clone git@github.com:eraclesax/documanager.git
creo un virtualenv
    cd documanager/
    sudo yum install python3 pip
    pip install virtualenv
    python3 -m virtualenv venv
installo i pacchetti dei requirements
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
creo un file .env
    touch .env
    nano .env
dentro ci metto
    ALLOWED_HOST=13.60.228.41
    DJANGO_SECRET_KEY=django-insecure-6@&(ti2fkhl&g0$ar)&wv=04+@6-lo8%l17@a(-0s4s&rf4oci
    DEBUG=False
    STATIC_ROOT=/var/www/documanager/static
L'host √® quello pubblico dichiarato dal provider
L'ultima opzione serve per Nginx, √® la cartella dove andr√† a prendersi i file statici

Installo Gunicorn (nel venv)
    pip install gunicorn
Ne testo il funzionamento
    gunicorn --bind 0.0.0.0:8000 core.wsgi:application
(se vedi la tua app su <EC2_PUBLIC_IP>:8000, funziona ‚úÖ),

creo il database e sposto i file statici
    python manage.py migrate
    python manage.py collectstatic

Crea un service systemd per avvio automatico:
    sudo nano /etc/systemd/system/gunicorn.service
contenuto:
    [Unit]
    Description=Gunicorn daemon for Django project
    After=network.target

    [Service]
    User=ec2-user
    Group=nginx
    WorkingDirectory=/home/ec2-user/documanager
    ExecStart=/home/ec2-user/documanager/venv/bin/gunicorn --workers 3 --bind unix:/run/gunicorn/documanager.sock core.wsgi:application

    [Install]
    WantedBy=multi-user.target
Una versione modificata che esplicita una variabile d'ambiente e l'indirizzo del file .env
    [Unit]
    Description=Gunicorn daemon for Django project
    After=network.target

    [Service]
    User=ec2-user
    Group=nginx
    WorkingDirectory=/home/ec2-user/documanager
    ExecStart=/home/ec2-user/documanager/venv/bin/gunicorn \
            --workers 3 \
            --bind unix:/run/gunicorn/documanager.sock \
            core.wsgi:application
    Environment="DJANGO_SETTINGS_MODULE=core.settings"
    EnvironmentFile=/home/ec2-user/documanager/.env

    [Install]
    WantedBy=multi-user.target

Creo la cartella in cui andr√≤ a mettere il socket. Deve essere accessibile di nginx:
    sudo mkdir -p /run/gunicorn
    sudo chown ec2-user:nginx /run/gunicorn
Poi:
    sudo systemctl start gunicorn
    sudo systemctl enable gunicorn
    sudo systemctl status gunicorn

Configuro Nginx:
Creo la cartella per i file statici
    sudo mkdir -p /var/www/documanager/static
Imposta la directory statica con gid e permessi di gruppo corretti:
(a volte l'utente nginx √® www-data)
    sudo chown -R ec2-user:nginx /var/www/documanager/static
    sudo chmod 2775 /var/www/documanager/static
Aggiungi il tuo utente al gruppo nginx
    sudo usermod -a -G nginx ec2-user
Controlla i permessi:
    ls -ld /var/www/documanager/static
Dovresti vedere qualcosa tipo:
    drwxr-sr-x 2 deployuser www-data 4096 ago 21 15:00 static
Creo il file di configurazione (ATTENTO! Se la cartella sites-available non esiste
√® probabile che nginx usi una convensione diversa per i file di configurazione).
Convenzione di ubuntu:
    sudo nano /etc/nginx/sites-available/documanager
Convenzione amazon linux:
    sudo nano /etc/nginx/conf.d/documanager.conf
contenuto per Ubuntu:
    server {
        listen 80;
        server_name 13.60.228.41;

        location = /favicon.ico { access_log off; log_not_found off; }
        location /static/ {
            root /var/www/documanager/static/;
        }

        location / {
            include proxy_params;
            proxy_pass http://unix:/var/www/documanager/run/gunicorn.sock;
        }
    }
contenuto per Amazon Linux (vedi chat con ChatGPT5, √® stato difficilissimo, sono stato 3 giorni):
upstream documanager {
    server unix:/var/www/documanager/run/gunicorn.sock fail_timeout=0;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name 13.60.228.41 localhost _;

    client_max_body_size 32M;

    access_log /var/www/documanager/logs/nginx_access.log;
    error_log /var/www/documanager/logs/nginx_error.log warn;

    location = /favicon.ico {
        alias /var/www/documanager/assets/favicon.ico;
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        alias /var/www/documanager/assets/robots.txt;
    }

    location /static/ {
        alias /var/www/documanager/static/;
    }

    location /assets/ {
        alias /var/www/documanager/assets/;
    }

    location / {
        proxy_pass http://documanager;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

creo la cartella static e la cartella logs

Attiva la config:
    sudo ln -s /etc/nginx/sites-available/documanager /etc/nginx/sites-enabled
    sudo nginx -t
    sudo systemctl restart nginx
Vai su http://13.60.228.41 ‚Üí dovrebbe comparire la tua app Django üéâ






    

--------------------------------------------------

Processo setup nuovo server:

scambio le chiavi di sicurezza con il provider
scopro il nome utente (ec2-user o ubuntu o altri)
scopro l'indirizzo pubblico DNS del server (ec2-13-53-205-189.eu-north-1.compute.amazonaws.com in questo caso)
entro nel server
    ssh -i "/home/riso/.ssh/ArchettiEC2.pem" ec2-user@ec2-13-53-205-189.eu-north-1.compute.amazonaws.com
aggiorno i pacchetti alle versioni di sviluppo
    sudo yum update
    sudo yum upgrade
(ad esempio qui aggiorno varie cose. credits https://tecadmin.net/how-to-install-python-3-12-on-amazon-linux/ 
e https://stackoverflow.com/questions/1210664/no-module-named-sqlite3 e 
https://www.giannifavilli.it/blog/python-django-su-webserver-nginx-e-gunicorn/ 
        Utilizzare privilegi di root o sudo.

        apt install python3 python3-pip python3-venv python3-dev
        apt install nginx supervisor
        apt install sqlite3
        Opzionali

        apt install curl git nano build-essential ‚Äì Tool Sviluppo
        apt install python3-certbot-nginx ‚Äì Certbot
        apt install libpq-dev postgresql postgresql-contrib ‚Äì PostgreSQL)
Qui installo python
    sudo yum groupinstall "Development Tools" -y
    sudo yum install gcc openssl-devel bzip2-devel libffi-devel -y
    sudo yum install sqlite-devel -y
    cd /usr/src
    sudo wget https://www.python.org/ftp/python/3.12.2/Python-3.12.2.tgz
    sudo tar xzf Python-3.12.2.tgz
    cd Python-3.12.2
    sudo ./configure --enable-optimizations --enable-loadable-sqlite-extensions
    sudo make
    sudo make altinstall
    python3.12 --version
(qui installo pip)
    sudo curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    sudo python3.12 get-pip.py
    pip3.12 --version
(qui installo nginx)
    sudo yum install nginx
(qui installo git)
    sudo yum install git
creo una nuova coppia di chiavi e scambio la chiave pubblica con github
    cd ~/.ssh/
    ssh-keygen -t ed25519 -C "eraclesax@github.com"
Adding your SSH key to the ssh-agent
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519
(se serve cambio i permessi di accesso e apertura della chiave e della cartella ssh)
    chmod ...
copio la chiave pubblica in github
    nano ~/.ssh/id_ed25519.pub
    -> copio la chiave in github
clono la repository
    cd ~/
    git clone git@github.com:eraclesax/documanager.git
creo un virtualenv
    cd documanager/
    sudo yum install python3 pip
    pip install virtualenv
    python3 -m virtualenv venv
installo i pacchetti dei requirements
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
creo un file .env
    touch .env
    nano .env
dentro ci metto
    ALLOWED_HOST=13.53.205.189 
    DEBUG=False
    STATIC_ROOT=/var/www/documanager/static
L'host √® quello pubblico dichiarato dal provider
L'ultima opzione serve per Nginx, √® la cartella dove andr√† a prendersi i file statici

Installo Gunicorn (nel venv)
    pip install gunicorn
Ne testo il funzionamento
    gunicorn --bind 0.0.0.0:8000 mysite_core.wsgi:application
(se vedi la tua app su <EC2_PUBLIC_IP>:8000, funziona ‚úÖ)
Crea un service systemd per avvio automatico:
    sudo nano /etc/systemd/system/gunicorn.service
contenuto:
    [Unit]
    Description=Gunicorn daemon for Django project
    After=network.target

    [Service]
    User=ec2-user
    Group=nginx
    WorkingDirectory=/home/ec2-user/documanager
    ExecStart=/home/ec2-user/documanager/venv/bin/gunicorn --workers 3 --bind unix:/run/gunicorn/documanager.sock core.wsgi:application

    [Install]
    WantedBy=multi-user.target
Una versione modificata che esplicita una variabile d'ambiente e l'indirizzo del file .env
    [Unit]
    Description=Gunicorn daemon for Django project
    After=network.target

    [Service]
    User=ec2-user
    Group=nginx
    WorkingDirectory=/home/ec2-user/documanager
    ExecStart=/home/ec2-user/documanager/venv/bin/gunicorn \
            --workers 3 \
            --bind unix:/run/gunicorn/documanager.sock \
            core.wsgi:application
    Environment="DJANGO_SETTINGS_MODULE=core.settings"
    EnvironmentFile=/home/ec2-user/documanager/.env

    [Install]
    WantedBy=multi-user.target

Creo la cartella in cui andr√≤ a mettere il socket. Deve essere accessibile di nginx:
    sudo mkdir -p /run/gunicorn
    sudo chown ec2-user:nginx /run/gunicorn
Poi:
    sudo systemctl start gunicorn
    sudo systemctl enable gunicorn

Configuro Nginx:
Creo la cartella per i file statici
    sudo mkdir /var/www
    sudo mkdir /var/www/documanager
    sudo mkdir /var/www/documanager/static
Imposta la directory statica con gid e permessi di gruppo corretti:
(a volte l'utente nginx √® www-data)
    sudo chown -R ec2-user:nginx /var/www/documanager/static
    sudo chmod 2775 /var/www/documanager/static
Aggiungi il tuo utente al gruppo nginx
    sudo usermod -a -G nginx ec2-user
Controlla i permessi:
    ls -ld /var/www/documanager/static
Dovresti vedere qualcosa tipo:
    drwxr-sr-x 2 deployuser www-data 4096 ago 21 15:00 static
Creo il file di configurazione:
    sudo mkdir /etc/nginx/sites-available
    sudo nano /etc/nginx/sites-available/documanager
contenuto:
    server {
        listen 80;
        server_name 13.53.205.189;

        location = /favicon.ico { access_log off; log_not_found off; }
        location /static/ {
            root /var/www/documanager/static/;
        }

        location / {
            include proxy_params;
            proxy_pass http://unix:/run/gunicorn/documanager/documanager.sock;
        }
    }
Attiva la config:
    sudo ln -s /etc/nginx/sites-available/documanager /etc/nginx/sites-enabled
    sudo nginx -t
    sudo systemctl restart nginx
Vai su http://13.53.205.189 ‚Üí dovrebbe comparire la tua app Django üéâ

creo il database e sposto i file statici
    python manage.py migrate
    python manage.py collectstatic


--------------------------------------------------------------------

Installazione certificato

Installa certbot
    sudo apt update
    sudo apt install certbot python3-certbot-nginx -y
Richiedi il certificato
    sudo certbot --nginx -d tuodominio.it -d www.tuodominio.it

-------------------------------------------------------------------

Definire un nuovo tag:

# Assicurati di essere aggiornato
git checkout development
git pull origin development

# Vai su master e aggiornalo
git checkout master
git pull origin master

# Fai il merge dello sviluppo su master
git merge --no-ff development -m "Merge branch 'development' into 'master' for release 1.0.0"

git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

3. Continuare lo sviluppo

Sul branch development continuerai a sviluppare nuove feature.
Sul branch master avrai solo le versioni stabili rilasciate.
Puoi anche creare un branch release/x.y.z se vuoi congelare il codice mentre testi/fissi bug prima di rilasciarlo.

4. Consiglio: Semantic Versioning

Seguire Semantic Versioning (SemVer)
 ti aiuta a dare un senso ai numeri di versione:
MAJOR: cambiamenti incompatibili (1.x.x ‚Üí 2.0.0).
MINOR: nuove feature compatibili (1.0.0 ‚Üí 1.1.0).
PATCH: fix retrocompatibili (1.0.0 ‚Üí 1.0.1).

-------------------------------------------------------------------------


Rimuovere file temporanei seguiti da git

rm -rf docdefunto/__pycache__/
echo "__pycache__/" >> .gitignore
git rm -r --cached docdefunto/__pycache__/
